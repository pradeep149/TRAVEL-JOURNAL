{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Home - Travel Journal</title>
    <link rel="stylesheet" href="{% static 'css/user_home.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                colSec: '#213638',
                colPri: '#CFE7E5',
                colHead: '#E5A13E',
                colBase: '#ffffff'
              }
            }
          }
        }
    </script>
    <style>
        .popup {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .popup.active {
            display: flex;
        }
        .popup-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-content a:hover {background-color: #ddd;}
        .dropdown:hover .dropdown-content {display: block;}
        .dropdown:hover .dropbtn {background-color: #3e8e41;}
        .navbar {
            display: flex;
            justify-content: center;
            background-color: #213638;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .navbar a {
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            transition: color 0.3s;
        }
        .navbar a:hover {
            color: #E5A13E;
        }
        .nav-active {
            border-bottom: 2px solid #E5A13E;
        }
        .search-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
            position: relative;
        }
        .search-bar input {
            border: 2px solid #213638;
            border-radius: 0.5rem;
            padding: 0.5rem 2.5rem 0.5rem 0.5rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 3%;
        }
        .search-icon {
            position: absolute;
            right: 31%;
            top: 27%;
            transform: translateY(-50%);
            color: #213638;
        }
    </style>
</head>
<body class="bg-colPri">
    <header class="flex justify-between items-center p-4 bg-colSec text-white">
        <h1 class="text-xl font-bold">Travel Journal</h1>
        <div>
            <button class="bg-colHead text-white px-4 py-2 rounded" id="createTripBtn">Create New Journey</button>
            <a href="{% url 'logout' %}" class="px-4 py-2 border-2 border-white rounded">Logout</a>
        </div>
    </header>

    <nav class="navbar">
        <a href="#dashboard" class="nav-dashboard">Dashboard</a>
        <a href="#myJourneys" class="nav-my-journeys nav-active">My Journeys</a>
    </nav>

    <main class="p-8">
        <div id="dashboard" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
            <div class="search-bar">
                <input type="text" id="dashboardSearch" placeholder="Search trips...">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.41-1.41l4.39 4.39a1 1 0 01-1.42 1.42l-4.38-4.39zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd" />
                    </svg>
                </span>
            </div>
            <p>Welcome to your travel journal dashboard!</p>
        </div>
        <div id="myJourneys">
            <h2 class="text-2xl font-bold mb-4">Welcome, {{ user.username }}</h2>
            <div class="search-bar">
                <input type="text" id="journeysSearch" placeholder="Search trips...">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.41-1.41l4.39 4.39a1 1 0 01-1.42 1.42l-4.38-4.39zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd" />
                    </svg>
                </span>
            </div>
            <div id="journeysList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for trip in trips %}
                    <div class="trip-item bg-white p-4 rounded shadow-lg relative">
                        <h3 class="trip-country text-xl font-bold">{{ trip.country }}</h3>
                        <p>Created on: {{ trip.created_at }}</p>
                        <p>Visibility: {{ trip.visibility }}</p>
                        <a href="{% url 'view_trip' user_id=trip.user.id trip_id=trip.id %}" class="text-colHead underline">View Trip</a>
                        <div class="dropdown absolute top-2 right-2">
                            <button class="dropbtn">â‹®</button>
                            <div class="dropdown-content">
                                <a href="#" class="deleteTripBtn" data-trip-id="{{ trip.id }}">Delete Trip</a>
                                <a href="#" class="toggleVisibilityBtn" data-trip-id="{{ trip.id }}" data-trip-visibility="{{ trip.visibility }}">Toggle Visibility</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <div id="createTripPopup" class="popup">
        <div class="popup-content">
            <h3 class="text-xl font-bold mb-4">Create New Journey</h3>
            <form method="post" action="{% url 'create_trip' %}">
                {% csrf_token %}
                <label for="country" class="block mb-2">Country</label>
                <input type="text" id="country" name="country" class="border p-2 mb-4 w-full" required>
                <button type="submit" class="bg-colHead text-white px-4 py-2 rounded">Create</button>
            </form>
            <button id="closeCreatePopupBtn" class="mt-4 text-red-600">Cancel</button>
        </div>
    </div>

    <div id="deleteTripPopup" class="popup">
        <div class="popup-content">
            <h3 class="text-xl font-bold mb-4">Delete Trip</h3>
            <p>Are you sure you want to delete this trip? This action cannot be undone and will delete all associated data including photos and notes.</p>
            <div class="flex justify-end">
                <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded mr-2">Delete</button>
                <button id="closeDeletePopupBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toggleVisibilityPopup" class="popup">
        <div class="popup-content">
            <h3 class="text-xl font-bold mb-4">Toggle Visibility</h3>
            <p id="toggleVisibilityMessage">Are you sure you want to change the visibility of this trip?</p>
            <div class="flex justify-end">
                <button id="confirmToggleVisibilityBtn" class="bg-colHead text-white px-4 py-2 rounded mr-2">Confirm</button>
                <button id="closeToggleVisibilityPopupBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('createTripBtn').onclick = function() {
            document.getElementById('createTripPopup').classList.add('active');
        }

        document.getElementById('closeCreatePopupBtn').onclick = function() {
            document.getElementById('createTripPopup').classList.remove('active');
        }

        document.querySelector('.nav-dashboard').onclick = function() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('myJourneys').classList.add('hidden');
            document.querySelector('.nav-dashboard').classList.add('nav-active');
            document.querySelector('.nav-my-journeys').classList.remove('nav-active');
        }
        document.querySelector('.nav-my-journeys').onclick = function() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('myJourneys').classList.remove('hidden');
            document.querySelector('.nav-dashboard').classList.remove('nav-active');
            document.querySelector('.nav-my-journeys').classList.add('nav-active');
        }

        let deleteTripId = null;
        document.querySelectorAll('.deleteTripBtn').forEach(button => {
            button.onclick = function() {
                deleteTripId = this.dataset.tripId;
                document.getElementById('deleteTripPopup').classList.add('active');
            }
        });

        document.getElementById('confirmDeleteBtn').onclick = function() {
            fetch(`/delete_trip/${deleteTripId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete trip.');
                }
            });
        }

        document.getElementById('closeDeletePopupBtn').onclick = function() {
            document.getElementById('deleteTripPopup').classList.remove('active');
        }

        let toggleVisibilityTripId = null;
        document.querySelectorAll('.toggleVisibilityBtn').forEach(button => {
            button.onclick = function() {
                toggleVisibilityTripId = this.dataset.tripId;
                const currentVisibility = this.dataset.tripVisibility;
                const newVisibility = currentVisibility === 'public' ? 'private' : 'public';
                document.getElementById('toggleVisibilityMessage').innerText = `Are you sure you want to make this trip ${newVisibility}?`;
                document.getElementById('toggleVisibilityPopup').classList.add('active');
            }
        });

        document.getElementById('confirmToggleVisibilityBtn').onclick = function() {
            fetch(`/toggle_visibility/${toggleVisibilityTripId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                if (response.ok) {
                    response.json().then(data => {
                        const newVisibility = data.new_visibility;
                        document.querySelector(`.toggleVisibilityBtn[data-trip-id='${toggleVisibilityTripId}']`).dataset.tripVisibility = newVisibility;
                        location.reload();
                    });
                } else {
                    alert('Failed to toggle visibility.');
                }
            });
        }

        document.getElementById('closeToggleVisibilityPopupBtn').onclick = function() {
            document.getElementById('toggleVisibilityPopup').classList.remove('active');
        }

        const journeysSearch = document.getElementById('journeysSearch');
        const journeysList = document.getElementById('journeysList');
        const tripItems = document.querySelectorAll('.trip-item');

        journeysSearch.addEventListener('input', function() {
            const filter = journeysSearch.value.toLowerCase();
            tripItems.forEach(item => {
                const country = item.querySelector('.trip-country').innerText.toLowerCase();
                if (country.includes(filter)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
