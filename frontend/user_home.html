{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Home - Travel Journal</title>
    <link rel="stylesheet" href="{% static 'css/user_home.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                colSec: '#213638',
                colPri: '#CFE7E5',
                colHead: '#E5A13E',
                colBase: '#ffffff'
              }
            }
          }
        }
    </script>
    <style>
        .popup {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .popup.active {
            display: flex;
        }
        .popup-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-content a:hover {background-color: #ddd;}
        .dropdown:hover .dropdown-content {display: block;}
        .dropdown:hover .dropbtn {background-color: #3e8e41;}
        .navbar {
            display: flex;
            justify-content: center;
            background-color: #213638;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .navbar a {
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            transition: color 0.3s;
        }
        .navbar a:hover {
            color: #E5A13E;
        }
        .nav-active {
            border-bottom: 2px solid #E5A13E;
        }
        .search-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
            position: relative;
        }
        .search-bar input {
            border: 2px solid #213638;
            border-radius: 0.5rem;
            padding: 0.5rem 2.5rem 0.5rem 0.5rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 3%;
        }
        .search-icon {
            position: absolute;
            right: 31%;
            top: 27%;
            transform: translateY(-50%);
            color: #213638;
        }

        .trip-item {
            cursor: pointer;
            overflow: hidden;
            border-radius: 0.5rem;
            transition: transform 0.3s ease-in-out;
            position: relative;
        }
        .trip-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .trip-content {
            padding: 1rem;
            background-color: white;
        }
        .trip-item:hover {
            transform: scale(1.05);
        }
        .dropbtn {
            background-color: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1;
        }

        .search-results-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .search-results-item:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body class="bg-colPri">
    <header class="flex justify-between items-center p-4 bg-colSec text-white">
        <h1 class="text-xl font-bold">Travel Journal</h1>
        <div>
            <button class="bg-colHead text-white px-4 py-2 rounded" id="createTripBtn">Create New Journey</button>
            <a href="{% url 'logout' %}" class="px-4 py-2 border-2 border-white rounded">Logout</a>
        </div>
    </header>

    <nav class="navbar">
        <a href="#dashboard" class="nav-dashboard">Dashboard</a>
        <a href="#myJourneys" class="nav-my-journeys nav-active">My Journeys</a>
    </nav>

    <main class="p-8">
        <div id="dashboard" class="hidden">
            <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
            <div class="search-bar">
                <input input type="text" id="dashboardSearch" placeholder="Search users...">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.41-1.41l4.39 4.39a1 1 0 01-1.42 1.42l-4.38-4.39zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd" />
                    </svg>
                </span>
            </div>
            <div id="searchResults" class="absolute bg-white border border-gray-200 rounded mt-1 max-h-64 overflow-y-auto w-full hidden">
            </div>
            <p>Welcome to your travel journal dashboard!</p>
        </div>
        <div id="myJourneys">
            <h2 class="text-2xl font-bold mb-4">Welcome, {{ user.username }}</h2>
            <div class="search-bar">
                <input type="text" id="journeysSearch" placeholder="Search trips...">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.41-1.41l4.39 4.39a1 1 0 01-1.42 1.42l-4.38-4.39zM14 8a6 6 0 11-12 0 6 6 0 0112 0z" clip-rule="evenodd" />
                    </svg>
                </span>
            </div>
            <div id="journeysList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for trip in trips %}
                    <div class="trip-item bg-white rounded shadow-lg cursor-pointer" onclick="location.href='{% url 'view_trip' user_id=trip.user.id trip_id=trip.id %}'">
                        {% with trip.photos.first as photo %}
                            {% if photo.image.url is not none %}
                                <img src="{{ photo.image.url }}" alt="Trip Image" class="rounded-t-lg">
                            {% endif %}
                            {% if photo.image.url is none %}
                                <img src="/static/media/tripbg.jpg" alt="Trip Image" class="rounded-t-lg">
                            {% endif %}
                        {% endwith %}
                        <div class="trip-content p-4">
                            <h3 class="trip-country text-xl font-bold">{{ trip.country }}</h3>
                            <p>Created on: {{ trip.created_at }}</p>
                            <p>Start Date: {{ trip.start_date }}</p>
                            <p>End Date: {{ trip.end_date }}</p>
                            <p>Visibility: {{ trip.visibility }}</p>
                        </div>
                        <div class="dropdown absolute top-2 right-2">
                            <button class="dropbtn">â‹®</button>
                            <div class="dropdown-content">
                                <a href="#" class="deleteTripBtn" data-trip-id="{{ trip.id }}">Delete Trip</a>
                                <a href="#" class="toggleVisibilityBtn" data-trip-id="{{ trip.id }}" data-trip-visibility="{{ trip.visibility }}">Toggle Visibility</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <div id="createTripPopup" class="popup">
        <div class="popup-content">
            <h3 class="text-xl font-bold mb-4">Create New Journey</h3>
            <form method="post" action="{% url 'create_trip' %}">
                {% csrf_token %}
                <label for="country" class="block mb-2">Country</label>
                <input type="text" id="country" name="country" class="border p-2 mb-4 w-full" required>
                <label for="start_date" class="block mb-2">Start Date</label>
                <input type="date" id="start_date" name="start_date" class="border p-2 mb-4 w-full" required>
                <label for="end_date" class="block mb-2">End Date</label>
                <input type="date" id="end_date" name="end_date" class="border p-2 mb-4 w-full" required>
                <button type="submit" class="bg-colHead text-white px-4 py-2 rounded">Create</button>
            </form>
            <button id="closeCreatePopupBtn" class="mt-4 text-red-600">Cancel</button>
        </div>
    </div>

    <div id="deleteTripPopup" class="popup">
        <div class="popup-content">
            <h3 class="text-xl font-bold mb-4">Delete Trip</h3>
            <p>Are you sure you want to delete this trip? This action cannot be undone and will delete all associated data including photos and notes.</p>
            <div class="flex justify-end">
                <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded mr-2">Delete</button>
                <button id="closeDeletePopupBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toggleVisibilityPopup" class="popup">
        <div class="popup-content">
            <h3 class="text-xl font-bold mb-4">Toggle Visibility</h3>
            <p id="toggleVisibilityMessage">Are you sure you want to change the visibility of this trip?</p>
            <div class="flex justify-end">
                <button id="confirmToggleVisibilityBtn" class="bg-colHead text-white px-4 py-2 rounded mr-2">Confirm</button>
                <button id="closeToggleVisibilityPopupBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        

        document.getElementById('createTripBtn').onclick = function() {
            document.getElementById('createTripPopup').classList.add('active');
        }

        document.getElementById('closeCreatePopupBtn').onclick = function() {
            document.getElementById('createTripPopup').classList.remove('active');
        }

        document.querySelector('.nav-dashboard').onclick = function() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('myJourneys').classList.add('hidden');
            document.querySelector('.nav-dashboard').classList.add('nav-active');
            document.querySelector('.nav-my-journeys').classList.remove('nav-active');
        }
        document.querySelector('.nav-my-journeys').onclick = function() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('myJourneys').classList.remove('hidden');
            document.querySelector('.nav-dashboard').classList.remove('nav-active');
            document.querySelector('.nav-my-journeys').classList.add('nav-active');
        }

        let deleteTripId = null;
        document.querySelectorAll('.deleteTripBtn').forEach(button => {
            button.onclick = function() {
                deleteTripId = this.dataset.tripId;
                document.getElementById('deleteTripPopup').classList.add('active');
            }
        });

        document.getElementById('confirmDeleteBtn').onclick = function() {
            fetch(`/delete_trip/${deleteTripId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete trip.');
                }
            });
        }

        document.getElementById('closeDeletePopupBtn').onclick = function() {
            document.getElementById('deleteTripPopup').classList.remove('active');
        }

        let toggleVisibilityTripId = null;
        document.querySelectorAll('.toggleVisibilityBtn').forEach(button => {
            button.onclick = function() {
                toggleVisibilityTripId = this.dataset.tripId;
                const currentVisibility = this.dataset.tripVisibility;
                const newVisibility = currentVisibility === 'public' ? 'private' : 'public';
                document.getElementById('toggleVisibilityMessage').innerText = `Are you sure you want to make this trip ${newVisibility}?`;
                document.getElementById('toggleVisibilityPopup').classList.add('active');
            }
        });

        document.getElementById('confirmToggleVisibilityBtn').onclick = function() {
            fetch(`/toggle_visibility/${toggleVisibilityTripId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                if (response.ok) {
                    response.json().then(data => {
                        const newVisibility = data.new_visibility;
                        document.querySelector(`.toggleVisibilityBtn[data-trip-id='${toggleVisibilityTripId}']`).dataset.tripVisibility = newVisibility;
                        location.reload();
                    });
                } else {
                    alert('Failed to toggle visibility.');
                }
            });
        }

        document.getElementById('closeToggleVisibilityPopupBtn').onclick = function() {
            document.getElementById('toggleVisibilityPopup').classList.remove('active');
        }

        document.querySelector('.nav-dashboard').addEventListener('click', function() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('myJourneys').classList.add('hidden');
            document.querySelector('.nav-dashboard').classList.add('nav-active');
            document.querySelector('.nav-my-journeys').classList.remove('nav-active');
        });
    
        document.querySelector('.nav-my-journeys').addEventListener('click', function() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('myJourneys').classList.remove('hidden');
            document.querySelector('.nav-dashboard').classList.remove('nav-active');
            document.querySelector('.nav-my-journeys').classList.add('nav-active');
        });


        const journeysSearch = document.getElementById('journeysSearch');
        const journeysList = document.getElementById('journeysList');
        const tripItems = document.querySelectorAll('.trip-item');

        journeysSearch.addEventListener('input', function() {
            console.log("searching...");
            const filter = journeysSearch.value.toLowerCase();
            tripItems.forEach(item => {
                const country = item.querySelector('.trip-country').innerText.toLowerCase();
                if (country.includes(filter)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        document.querySelectorAll('.dropdown-content a').forEach(item => {
            item.addEventListener('click', event => {
                event.stopPropagation();
            });
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const dashboardSearch = document.getElementById('dashboardSearch');
            const searchResults = document.getElementById('searchResults');
        
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        
            const csrftoken = getCookie('csrftoken');
        
            dashboardSearch.addEventListener('input', function() {
                const query = dashboardSearch.value;
                if (query.length > 0) {
                    fetch(`/search_users/?q=${query}`, {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        searchResults.innerHTML = '';
                        if (data.users.length > 0) {
                            data.users.forEach(user => {
                                const resultItem = document.createElement('div');
                                resultItem.classList.add('search-results-item');
                                resultItem.innerText = user.username;
                                resultItem.onclick = () => window.location.href = `/profile/${user.id}/`;
                                searchResults.appendChild(resultItem);
                            });
                            searchResults.classList.remove('hidden');
                        } else {
                            searchResults.classList.add('hidden');
                        }
                    });
                } else {
                    searchResults.classList.add('hidden');
                }
            });
        });
        
        
    </script>
</body>
</html>
